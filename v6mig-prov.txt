IPv6マイグレーション技術の国内標準プロビジョニング方式 【第0.3版】

IPv6普及・高度化推進協議会 IPv4/IPv6共存WG IPv6家庭用ルータSWG


変更履歴

  1.0版  20xx年x月xx日
    - 初版


目次

1.  本文書作成の背景と目的
2.  ネットワーク構成 (TBD)
  2.1.  VNEにて必要となる設備
3.  プロビジョニング方式仕様
  3.1.  プロビジョニングサーバの発見方法
  3.2.  プロビジョニングサーバへの接続手段
  3.3.  データフォーマット（プロビジョニングサーバへ送信）(TBD)
  3.4.  データフォーマット（プロビジョニングサーバから受信）(TBD)
  3.5.  プロビジョニングデータの管理
  3.6.  プロビジョニングサーバへのアクセスシーケンス
4.  検討メンバー(TBD)



1.  本文書作成の背景と目的

日本国内において、NTT東西によるフレッツ光ネクストのNGN IPv6契約者数は、
1,200万契約を超過しており、NGN IPv6普及率も57.8%となっており、IPv6サービスの
本格的な普及が進んでいる。(2018年12月時点)　

IPv6サービスの普及と同時に、各VNE事業者によるIPv6マイグレーション技術を
使用したIPv4 over IPv6サービスの普及が加速しているが、各VNE事業者が採用
しているIPv6マイグレーション技術およびプロビジョニング方式が各社独自と
なっている為、今後、新規にIPv4 over IPv6サービスを提供予定のVNE事業者に
おいても、独自方式で提供される可能性が高く、各社が独自方式を採用すること
による問題が懸念される。

具体的には、家庭用ルータベンダにおいて、VNE各社独自のプロビジョニング方式
を搭載することによるサービス自動判別機能の複雑化や、開発工数・評価工数の
増大による製品価格への転嫁などが想定され、エンドユーザによる間接的なコスト
負担が懸念される。

本文書は、上記問題を解決することを目的として、国内標準のプロビジョニング
方式の仕様を策定したものであり、特に新規VNE事業者に対して当該標準方式の
採用を期待するものである。尚、既にサービス提供中のVNE事業者においては、
国内標準方式へ移行する上での得失を考慮した上で判断いただければ幸いである。

本国内標準方式の適用範囲は、フレッツ光ネクストに限定するものではなく、
CATVネットワークや他の通信事業者のサービスへの適用が可能なものとなっている。
尚、本国内標準方式を、国際標準として提案するか否かについては、今後の検討
事項である。

本国内標準方式が、家庭用ルータベンダの製品に標準搭載され、かつ新規VNE事業者に
おけるプロビジョニング方式となるよう当該SWGとして普及啓発のための活動を行う。


1.1. 要求度を表す用語

本文書では "MUST", "SHOULD", "MAY" の単語を用いて、記述の要求度を定める。
各単語の意味は RFC2119 に従う。

 - MUST : 必須。必ず必要とされる機能。
 - SHOULD : 推奨。実装されることが推奨される機能。ただし、特定の状況下において
   妥当な理由が存在する場合は実装しないことが許容される。
 - MAY : オプション。実装は付加価値的なものであるため任意でよい機能。

1.2. 用語集

 - CPE
   - 本文書で規定するプロビジョニング方式を実装したルータ
 - プロビジョニングサーバ
   - CPE からの要求に基づき本文書で規定する各種パラメータを応答する
     HTTP または HTTPS サーバ
 - プロビジョニング方式対応 DNS サーバ
   - CPE が参照するフルサービスリゾルバであり、本文書で規定する専用ドメイン
     名に対する TXT レコードの問い合わせに対し、本文書で規定するフォーマットで
     記述された TXT レコードを返す DNS サーバ


2.  ネットワーク構成 (TBD)

全体概念図
                             +----------+
                             |DNS Server|
                             +-----+----+
                                   |
                                .--+--.                        .-----.
                               /       \     +----------+     /       \
      .-----.     +-------+   /  IPv6-  \    | Center   |    /  IPv4-  \
     / Local \    |       +--(  Network  )---+ Equipment|---(  Internet )
    /         \   |  CPE  |   \         /    +----------+    \         /
   (   Home-   )--+       |    \       /                      \       /
    \ Network /   +-------+     --+---'                        ---+--'
     \       /                     |
      `-----'               +------+-----+
                            |Provisioning|
                            |   Server   |
                            +------------+

シーケンス(概要)

                       DNS       プロビジョニング
    CPE                サーバ    サーバ           センタ装置      IPv4ノード
    |                  |         |                |               |
    |プロビサーバ発見  |         |                |               |
    |=================>|         |                |               |
    |                  |         |                |               |
    | プロビサーバ応答 |         |                |               |
    |<=================|         |                |               |
    |                  |         |                |               |
    |パラメータ要求    |         |                |               |
    |===========================>|                |               |
    |                  |         |                |               |
    |             パラメータ応答 |                |               |
    |<===========================|                |               |
    |                  |         |                |               |
    |             IPv4 over IPv6 通信             |   IPv4 通信   |
    |<===========================================>|<=============>|
    |                  |         |                |               |
    |                  |         |                |               |


2.1.  VNEにて必要となる設備

  -  DNSキャッシュサーバ(特定FQDNのリソースレコードに対するDNS設定)
  -  本方式に準拠したプロビジョニングサーバ(http or https)
  -  IPv4 over IPv6センタ装置(IPv6マイグレーション技術対応)



3.  プロビジョニング方式仕様

3.1.  プロビジョニングサーバの発見方法

プロビジョニングサーバの発見は以下 FQDN に対するDNS の名前解決にて行う。

    example.v6pc.jp (TBD)

プロビジョニングサーバの URL とサポートする接続方式を TXT リソースレコー
ドにより取得する。TXT リソースレコードにおけるフォーマットは下記の通りと
し(両端の二重引用符は含まない)、複数記述はせず単一の応答のみを返すことと
する。

    "v=v6mig-1 url=https://vne.example.jp/rule.cgi t=b"

各項目については下記の通り。

  v : バージョンを示す。"v6mig-1" を固定値とする。

  url : プロビジョニングサーバのURLを示す。

  t : 証明書検証の要否を示す。
    a : 証明書検証を行わない
    b : 証明書検証を行う


3.2.  プロビジョニングサーバへの接続手段

プロビジョニングサーバへの接続手段は、VNE事業者にて以下の中から選択可能である。

  a) http を利用する。
  b) https を利用するが、証明書検証を行わない。
  c) https を利用し、自己署名のサーバ証明書を使用する。
  d) https を利用し、認証局発行のサーバ証明書を使用する。


各々の接続手段におけるメリット、デメリットを以下に示す。

a) http
   - メリット
     1) サーバ証明書が不要
   - デメリット
     1) 通信内容が暗号化されないため、通信内容を容易に解読することが可能。
   - 備考
     - 有効だが、安全性の検討が必要。
     - ※公開情報を配布するのであれば考慮不要。

b) https 自己署名のサーバ証明書を使用 ※証明書検証を行わない
   - メリット
     1) サーバ証明書の管理は不要
     2) 通信内容が暗号化される。
   - デメリット
     1) サーバ証明書をクライアント側で検証できない。
     2) サーバのなりすまし防止ができない為、送信情報が解読される可能性あり。
   - 備考
     - 運用コストが低い。

c) https 自己署名のサーバ証明書を使用 ※証明書検証を行う
   - メリット
     1) 通信内容が暗号化される。
     2) サーバ証明書をクライアント側で検証可能。
     3) サーバのなりすまし防止が可能。
   - デメリット
     1) サーバ証明書の管理(有効期限)が必要。
     2) クライアント側にCA証明書が必要。※CPEで証明書を保持する必要あり。
   - 備考
     - 安全性は確保できるが危殆化のリスクあり。各社のCA証明書の管理コスト発生。

d) https 認証局発行のサーバ証明書を使用
   - メリット
     1) 通信内容が暗号化される。
     2) サーバ証明書をクライアント側で検証可能。
     3) サーバのなりすまし防止が可能。
   - デメリット
     1) サーバ証明書の管理(有効期限、費用等)が必要。
     2) クライアント側にCA証明書が必要。
   - 備考
     - 理想的だが、運用上の課題(運用によってはサービス停止リスク)がある。
     - サーバ証明書をクライアント側でチェックしない場合、自己署名のサーバ
       証明書使用と同様のデメリットあり。


3.3.  データフォーマット（プロビジョニングサーバへ送信）

プロビジョニングサーバへのプロビジョニング情報要求は、HTTP/HTTPS リクエ
ストの GET メソッドを用いてリクエストを行う。
※送信タイミングについては、「プロビジョニングサーバへのアクセスシーケン
ス」を参照。

    GET /config?<パラメータ名>=<値>&<パラメータ名>=<値>&... HTTP/1.1

リクエストを行う際、以下の情報をパラメータとして付与し、CPE からプロビ
ジョニングサーバへ送信する。

・vendorid
   ベンダーOUI、および、任意コード24文字を以下のフォーマットで送信する。(MUST)
  「ベンダーOUI(16進数表記6文字)」＋「-」＋「任意文字(0-9,a-z,A-Z,_のみ)
  最大24文字」
  ベンダーOUIのみをMUSTとし、ハイフン以降の値の付与は任意とする。

  ex) vendorid=343dc4-aebb198a003e7fce98fe7765bc


・product
  CPE 本体の製品名を値として送信する。(MUST)
  値は ASCII 半角英数字、ハイフン、アンダースコアで構成される 32 文字以
  下とする。

  ex) product=V6MIG-ROUTER


・version
  CPE のファームウェアバージョンを送信する。(MUST)
  値は、数字またはアンダースコアからなる最大 32 文字の文字列とする
  (`[0-9_]{1,32}`)。ピリオドの代わりにアンダースコアを利用すること。

  ex) version=1_32


・capability
  CPE のサポートするマイグレーション技術を送信する。(MUST)
  サポートする以下のマイグレーション技術を「_」(アンダースコア）で接続した
  文字列を送信する。

  MAP-E    CPEはMAP-E方式をサポートする。
  MAP-T    CPEはMAP-T方式をサポートする。
  DS-LITE  CPEはDS-Lite方式をサポートする。
  LW4O6    CPEはLightweight 4over6方式をサポートする。
  464XLAT  CPEは464XLATをサポートする。
  IPIP     CPEはIPIPトンネル接続をサポートする。
  HUBSPOKE CPEはHub&Spoke方式をサポートする。
  MESH     CPEはMESH方式をサポートする。

  ex) capability=MAP-E_DS-LITE_LW4O6_HUBSPOKE


・token
  CPE が既にプロビジョニングサーバに接続したことがあり、その際にプロビ
  ジョニング情報として token が与えられている場合、前回取得した token の
  値を付与する。(MAY)
  この値はプロビジョニングサーバ側がこのCPEを個別に判別するために利用さ
  れる。
  (TBD) プロビジョニング情報内の token パラメータ参照先


3.4.  データフォーマット（プロビジョニングサーバから受信）(TBD)

プロビジョニング情報を格納するデータフォーマットは、RFC7598にて定義されて
いるフォーマットをベースとしたJSONフォーマットとし、不足するパラメータ等
については独自に追加を行っている。
CPE は、JSON オブジェクトの未知のキーは無視してよい(MAY)。

以下にデータフォーマットを示す。

{
  "enabler_name": "A VNE",
  "service_name": "Highspeed 4over6",
  "isp_name": "ISP-A",
  "ttl": 86400,
  "order": [ "464xlat", "map_e", "dslite" ],
  "map_e": {
    "version": 0,
    "mesh": true,
    "br": "2001:db8:1::1",
    "rules": [
      {
        "ipv6": "2001:db8:1:2000:/52",
        "ipv4": "203.0.113.0/24",
        "ea_length": 12,
        "psid_offset": 4
      }
    ]
  },
  "dslite": {
    "aftr": "aftr.example.net"
  },
  "lw4o6": {
    "lwaftr": "lwaftr.example.net",
    "ipv6": "2001:db8:3:100::/56",
    "ipv4": "203.0.113.16",
    "psid": 3,
    "psid_length": 8,
    "psid_offset": 6
  },
  "map_t": {
    "dmr": "2001:db8:5::/64",
    "rules": [
      {
        "ipv6": "2001:db8:5:100::/56",
        "ipv4": "203.0.113.32/28",
        "ea_length": 8,
        "psid_offset": 4
      }
    ]
  },
  "464xlat": {
    "nat64prefix": "2001:db8:6::/96"
  },
  "ipip": [
    {
      "ipv6_local": "2001:db8:7:100::7",
      "ipv6_remote": "2001:db8:7::1",
      "ipv4": "203.0.113.0/29"
    }
  ]
}

Object Value

IP4OV6ServiceProviderName
  NGN上でのサービスではVNE名
  JPNE, IMF, NTTコミュニケーションズ, Biglobe等 NGN以外でのサービスではISP名
  au、J-COM等
　
IP4OV6VNEServiceName
  IPv4 over IPv6 VNEサービス名
  NGNが指定のサービス名を設定する。
  NGN
  NGN以外でのサービスの場合は、設定しないこと。
　
IP4OV6ISPServiceName オプション
  IPv4 over IPv6 ISPサービス名
  IP4OV6VNEServiceName < IP4OV6ISPServiceNameの関係にすること。
　
IP4OV6ISPTTL
  TTL : プロビ情報の有効期間。単位は秒。
　
PriorityConfig
  マイグレーション方式を優先度順に並べたもの。プロビジョニングデータに複数
  の方式が記述されている場合、CPE は PriorityConfig に記述された順序で各方
  式の利用を試みる。

  マイグレーション方式には以下の文字列のいずれかを指定する。

    "MAP-E", "MAP-T", "DS-Lite", "LW4o6", "464XLAT", "IPIP"

  なお、CPE は、PriorityConfig の設定によらずユーザが固定的に設定できるモー
  ドを備えることが望ましい。

MAP-E
  MAP-Eプロビジョニングデータ(グループ)
　
MAP-ESupportVersion オプション
  MAP-E プロトコルのバージョンを表す。

  0 or 項目なし : draft-ietf-softwire-map-03
  1 : RFC7597
 　
MAP-ETrafficMode
  RFC7597 に記載の MAP-E の Hub-and-spoke モードと Mesh モードを指定する。

  0 or 項目なし : Hub-and-spoke mode (CE - BR only)
  1 : Mesh mode (CE - BR and CE - CE)
　
MAP-EBRAddress
  BR のアドレス。

MAP-ERules
  MAP-Eのルール(グループ)

  - Hub-Spoke/Meshモード時ともに、フォーマットとしては256ルールを受け入れること(MUST)
  - Hub-Spokeモード時は、ルールの最大数は256ルールを受け入れること。(MUST)
  - 動作要件として、Meshモード時は256ルールで動作すること。(SHOULD)
  　(※性能要件の妥当性はベンダ次第)

MAP-EFMRIPv6Prefix
  FMRのIPv6プリフィックス
　
MAP-EIPv6PrefixLength
  FMRのIPv6プリフィックス長
　
MAP-EIPv4Prefix
  FMRのIPv4プリフィックス
　
MAP-EIPv4PrefixLength
  FMR の IPv4 プリフィックス長
　
MAP-EEABitLength
  EAビット長
　
MAP-EPSIDOffset
  PSID オフセット
　
DS-Lite
  DS-Lite プロビジョニングデータ(グループ)
　
aftr
  DS-Lite AFTR の DNS 名もしくは IPv6 アドレス。

LW4o6
  lw4o6プロビジョニングデータ(グループ)

LW4o6Rules
  LW4o6のルール(グループ)。ルールの最大数は、活用事例が発生した際に定める。

lwaftr
  lwAFTR の DNS 名もしくは IPv6 アドレス。

V4V6BINDV6Prefix
  Operator Assigned IPv6 Prefix
　
V4V6BINDV4ADDRESS
  IPv4 external (public) address for NAPT44
　
V4V6BINDPSID
  Restricted port set to use for NAPT44
　
MAP-T
  MAP-Tプロビジョニングデータ(グループ)
　
MAP-TRules
  MAP-Tのルール(グループ) ルールの最大数は200ルール
　
MAP-TDMRAddress
  DMRのアドレス
　
MAP-TDMRPrefixLength
  DMRのプリフィックス長
　
MAP-TFMRIPv6Prefix
  FMRのIPv6プリフィックス
　
MAP-TIPv6PrefixLength
  FMRのIPv6プリフィックス長
　
MAP-TIPv4Prefix
  FMRのIPv4プリフィックス
　
MAP-TIPv4PrefixLength
  FMRのIPv4プリフィックス長
　
MAP-TEABitLength
  EAビット長
　
MAP-TPSIDOffset
  PSIDオフセット

464XLAT
  464XLATプロビジョニングデータ(グループ)

nat64prefix
  NAT64 プレフィックス。

IPIPLocalAddress
  IPIPトンネルの送信元IPv6アドレス

IPIPRemoteAddress
  IPIPトンネルの宛先IPv6アドレス

IPIPIPv4Address
  IPIPトンネルのIPv4固定アドレス

IPIPIPv4Prefix
  IPIPトンネルのIPv4固定アドレスのプレフィックス長


3.5.  プロビジョニングデータの管理

プロビジョニングサーバから正常に取得した各種パラメータ情報について、
当該CPEに必要な情報を不揮発領域に格納することができる。(MAY)
サーバ障害時などプロビサーバへの到達性が無い場合に、不揮発領域に格納されている情報を使う。(MAY)
この機能を持つCPEは、不具合発生時に備えて、格納された情報を
不揮発領域から消去する手段を備える。(SHOULD)


3.6.  プロビジョニングサーバへのアクセスシーケンス

以下にプロビジョニングサーバへのアクセスシーケンスおよび状態遷移を示す。

a) 開始
b) DNSクエリーでAAAA,TEXT RRの情報を取得する
c) プロビジョニングサーバのアドレスと通信方式が取得できたか
   c.1) 取得できた場合
        - d) へ
   c.2) 取得できなかった場合
        - 1-10分のランダムな時間を待つ
        - a) へ
d) プロビジョニングサーバーへ情報へCPE情報を送信する
e) プロビジョニングサーバーから情報を取得する
f) プロビジョニングサーバーから返答があったか
   f.1) 返答がある場合
        - g) へ
   f.2) 返答がない場合
        - 10-30分間のランダムな時間を待つ
        - a) へ
g) プロビジョニング情報を解析する
h) ステータス確認をする
   h.1) 有効なプロビジョニングデータの場合
        i) へ
   h.2) 契約無効の場合
        - CPEにマイグレ技術が動作している場合、機能を無効にする
        - 1-3 時間のランダムな時間を待つ
        - a) へ
   h.3) エラーの場合
        - CPEにマイグレ技術が動作している場合、機能を無効にする
        - 10-30 分間のランダムな時間を待つ
        - a) へ
i) 以前にマイグレ技術が設定されて有効か
   i.1) 有効な場合
        - 以前の設定から変更があれば k) へ
        - 以前の設定から変更がなければ l) へ
   i.2) 無効な場合
        - k) へ
k) プロビジョニングデータに合わせて、CPEを設定する
l) プロビジョニングデータにTTLが設定されているか
   l.1) 設定されている場合
        - TTL の時間待つ
        - a) へ
   l.2) 設定されていない場合
        - 20-24 時間待つ
        - a) へ



4.  検討メンバー(TBD)

下記に検討メンバーを示す．所属の50音順に従っている．

エヌ・ティ・ティ・コミュニケーションズ株式会社
藤崎 智宏（部会長）

ＮＥＣプラットフォームズ株式会社
川島 正伸（部会長）

株式会社インターネットイニシアティブ
佐原 具幸（部会長）

株式会社アイ・オー・データ機器
田畑 敬司

株式会社アイ・オー・データ機器
吉田 幸男

株式会社ネクステック
大石 憲且

ＮＥＣプラットフォームズ株式会社
大石 智雄

ＮＥＣプラットフォームズ株式会社
前田 康貴

ＮＥＣプラットフォームズ株式会社
中村 敏夫

株式会社バッファロー
山田 大輔

株式会社バッファロー
稲田 哲也

ヤマハ株式会社
下薗 大樹

ヤマハ株式会社
太田 将博
